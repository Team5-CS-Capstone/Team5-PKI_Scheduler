

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>app &mdash; PKI Scheduler - Team 5 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            PKI Scheduler - Team 5
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../modules.html">python-db</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jsdoc.html">JSDoc Documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PKI Scheduler - Team 5</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Module code</a></li>
      <li class="breadcrumb-item active">app</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for app</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">flask</span><span class="w"> </span><span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">jsonify</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">flask_cors</span><span class="w"> </span><span class="kn">import</span> <span class="n">CORS</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlite3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">csv</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">secure_filename</span>

<span class="c1"># Importing utility functions from utils.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">parse_instructor</span><span class="p">,</span> <span class="n">get_or_create_professor</span><span class="p">,</span> <span class="n">fix_csv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">algorithm</span><span class="w"> </span><span class="kn">import</span> <span class="n">recommend_swaps_per_timeslot</span><span class="p">,</span> <span class="n">recommended_swaps_if_no_swaps_in_same_timeslot</span>
<span class="c1"># Importing the algorithm to get swap recommendations</span>

<span class="c1"># Little overview of the imports above (uses):</span>
<span class="c1"># flask → Web framework</span>
<span class="c1"># flask-cors → Allows Vue to communicate with Flask</span>
<span class="c1"># flask-sqlalchemy → ORM for SQLite</span>
<span class="c1"># pandas → CSV parsing</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="c1"># Allow frontend requests using CORS from any origin</span>
<span class="n">CORS</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">supports_credentials</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Our SQLite database file</span>
<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;database.db&quot;</span>
<span class="c1"># Document Uploads file</span>
<span class="n">BASE_DIR</span>       <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="o">.</span><span class="n">parent</span>          <span class="c1"># folder that holds app.py</span>
<span class="n">AUDIT_DIR</span>      <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">&quot;audit_logs&quot;</span>
<span class="n">AUDIT_DIR</span>      <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">&quot;audit_logs&quot;</span>
<span class="n">UPLOAD_DIR</span>     <span class="o">=</span> <span class="n">BASE_DIR</span> <span class="o">/</span> <span class="s2">&quot;uploads&quot;</span>
<span class="n">UPLOAD_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">AUDIT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Audit log file for swapped classes</span>
<span class="n">swap_file</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AUDIT_DIR</span><span class="p">,</span> <span class="s2">&quot;section_swaps.txt&quot;</span><span class="p">)</span>
<span class="n">AUDIT_DIR</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Audit log file for swapped classes</span>
<span class="n">swap_file</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">AUDIT_DIR</span><span class="p">,</span> <span class="s2">&quot;section_swaps.txt&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="get_possible_reassignments">
<a class="viewcode-back" href="../app.html#app.get_possible_reassignments">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/class/&lt;int:class_id&gt;/possible-reassignments&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_possible_reassignments</span><span class="p">(</span><span class="n">class_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve possible reassignments for a specific class.</span>

<span class="sd">    :param class_id: ID of the class to fetch possible reassignments for.</span>
<span class="sd">    :type class_id: int</span>

<span class="sd">    :return: JSON response containing the list of possible reassignments.</span>
<span class="sd">    :rtype: flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">row_factory</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">Row</span> <span class="c1"># Enable row factory to access columns by name</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        WITH target_class AS (</span>
<span class="s2">                    SELECT id, meeting_pattern, enrollment,</span>
<span class="s2">                    max_enrollment, room, course_number, course_title</span>
<span class="s2">                    FROM classes</span>
<span class="s2">                    WHERE id = ?</span>
<span class="s2">                )</span>
<span class="s2">                    SELECT b.*</span>
<span class="s2">                    FROM classes b, target_class t</span>
<span class="s2">                    WHERE b.id != t.id</span>
<span class="s2">                    AND b.meeting_pattern = t.meeting_pattern -- same meeting times</span>
<span class="s2">                    AND t.max_enrollment &gt;= b.enrollment -- target class can accommodate the other class</span>
<span class="s2">                    AND b.max_enrollment &gt;= t.enrollment -- other class can accommodate the target class</span>
<span class="s2">                    AND  NOT (b.enrollment = 0 AND b.max_enrollment = 0) -- ignore classes with no enrollment (they&#39;re remote classes)</span>
<span class="s2">                ORDER BY (b.max_enrollment - b.enrollment) ASC -- sort by available seats</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">class_id</span><span class="p">,))</span>
    <span class="n">partners</span> <span class="o">=</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">partners</span><span class="p">),</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="get_classes">
<a class="viewcode-back" href="../app.html#app.get_classes">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/classes&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_classes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve a list of classes from the database.</span>

<span class="sd">    A connection to the SQLite database is established, and all records are fetched </span>
<span class="sd">    from the ``classes`` table. The attributes fetched are ``id``, ``section``, </span>
<span class="sd">    ``course_number``, and ``course_title``. These are returned as a JSON array.</span>

<span class="sd">    :return: JSON response containing the list of class objects along with an HTTP 200 status.</span>
<span class="sd">    :rtype: flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>  <span class="c1"># Connect to database</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT id, section, course_number, course_title, enrollment, max_enrollment FROM classes&quot;</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Serialize the data</span>
    <span class="n">classes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">class_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;section&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;courseName&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;courseTitle&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> 
            <span class="s2">&quot;currentEnrollment&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
            <span class="s2">&quot;maxEnrollment&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
        <span class="p">}</span>
        <span class="n">classes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">class_data</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">classes</span><span class="p">),</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="get_professors">
<a class="viewcode-back" href="../app.html#app.get_professors">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/class/&lt;int:class_id&gt;/professors&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_professors</span><span class="p">(</span><span class="n">class_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve the professors associated with a specific class.</span>

<span class="sd">    :param class_id: ID of the class to fetch professors for.</span>
<span class="sd">    :type class_id: int</span>

<span class="sd">    :return: JSON response containing the list of professors for the specified class.</span>
<span class="sd">    :rtype: flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        SELECT professors.id, professors.first_name, professors.last_name, professors.p_id</span>
<span class="s2">        FROM professors</span>
<span class="s2">        JOIN class_professors ON professors.id = class_professors.professor_id</span>
<span class="s2">        WHERE class_professors.class_id = ?</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">class_id</span><span class="p">,))</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="n">professors</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="n">professors</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;first_name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;last_name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;p_id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
        <span class="p">})</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">professors</span><span class="p">),</span> <span class="mi">200</span></div>


<span class="c1"># API Route to fetch class details by ID </span>
<div class="viewcode-block" id="get_class">
<a class="viewcode-back" href="../app.html#app.get_class">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/class/&lt;int:class_id&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_class</span><span class="p">(</span><span class="n">class_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieve information about a single class using its numeric ID.</span>

<span class="sd">    Args:</span>
<span class="sd">        class_id (int): </span>
<span class="sd">            The ID of the class to fetch from the database.</span>

<span class="sd">    Returns:</span>
<span class="sd">        flask.Response: </span>
<span class="sd">            A JSON response with two possible outcomes:</span>
<span class="sd">            </span>
<span class="sd">            * **200 OK** – If the class is found, returns a JSON object of class data.</span>
<span class="sd">            * **404 Not Found** – If the class is not found, returns a JSON error message.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">class_data</span> <span class="o">=</span> <span class="n">get_class_details</span><span class="p">(</span><span class="n">class_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">class_data</span><span class="p">:</span>
        <span class="c1"># serialize and return class data if class is found</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">class_data</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># otherwise provide a 404 error and message along with it </span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Class not found&quot;</span><span class="p">}),</span> <span class="mi">404</span></div>

    
<div class="viewcode-block" id="get_class_details">
<a class="viewcode-back" href="../app.html#app.get_class_details">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_class_details</span><span class="p">(</span><span class="n">class_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A helper function that returns class details.</span>

<span class="sd">    Args:</span>
<span class="sd">        class_id (int):</span>
<span class="sd">            The ID of the class to fetch from the database.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict:</span>
<span class="sd">            A dictionary of class details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>  <span class="c1"># Connect to database</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM classes WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">class_id</span><span class="p">,))</span>
    <span class="c1"># fetch just one row as theres only one class per id</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">row</span><span class="p">:</span>
        <span class="n">class_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
            <span class="s2">&quot;term&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
            <span class="s2">&quot;courseName&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="s2">&quot;section&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>  <span class="c1"># Course Title</span>
            <span class="s2">&quot;room&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span>
            <span class="s2">&quot;currentEnrollment&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
            <span class="s2">&quot;maxEnrollment&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">class_data</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<span class="c1"># API Route to receive and handle CSV importing</span>
<div class="viewcode-block" id="upload_file">
<a class="viewcode-back" href="../app.html#app.upload_file">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/upload&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">upload_file</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Upload and process a CSV file.</span>

<span class="sd">    .. note::</span>
<span class="sd">        Expects a form field named ``file``.</span>

<span class="sd">    :return: JSON response indicating success or failure.</span>
<span class="sd">    :rtype: flask.Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># check if file was uploaded</span>
    <span class="k">if</span> <span class="s1">&#39;file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="s2">&quot;No file uploaded&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    
    <span class="n">file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;file&#39;</span><span class="p">]</span>
    <span class="k">global</span> <span class="n">file_path</span> <span class="c1"># make sure the file path is global so we can access it later</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">UPLOAD_DIR</span><span class="p">,</span> <span class="n">file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>  <span class="c1"># Save file in uploads folder</span>

    <span class="c1"># Parse CSV file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">fix_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="c1"># Function call to fix the sheet for trailing commas</span>
        <span class="n">create_tables</span><span class="p">()</span> <span class="c1"># Create the tables in the database</span>
        <span class="n">course_data</span> <span class="o">=</span> <span class="n">parse_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>  <span class="c1"># Parse the CSV file</span>
        <span class="n">insert_csv_into_table</span><span class="p">(</span><span class="n">course_data</span><span class="p">)</span> <span class="c1"># Insert the parsed data into the database</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)}),</span> <span class="mi">400</span>
    
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;File uploaded successfully!&quot;</span><span class="p">,</span> <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="n">file_path</span><span class="p">}),</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="create_tables">
<a class="viewcode-back" href="../app.html#app.create_tables">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_tables</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create the ``classes`` table in the database.</span>

<span class="sd">    If it exists, it is dropped before re-creation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>  <span class="c1"># Connect to database</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Drop the &#39;classes&#39; table if it exists</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS classes&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS professors&quot;</span><span class="p">)</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS class_professors&quot;</span><span class="p">)</span>

    <span class="c1"># Now, create the &#39;classes&#39; table</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        CREATE TABLE classes (</span>
<span class="s2">            id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">            term TEXT,</span>
<span class="s2">            course_number TEXT,</span>
<span class="s2">            section TEXT,</span>
<span class="s2">            course_title TEXT,</span>
<span class="s2">            room TEXT,</span>
<span class="s2">            meeting_pattern TEXT,</span>
<span class="s2">            enrollment INTEGER,</span>
<span class="s2">            max_enrollment INTEGER,</span>
<span class="s2">            professor_id INTEGER,</span>
<span class="s2">            UNIQUE (term, course_number, section)</span>
<span class="s2">        )</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># Create the &#39;professors&#39; table</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            CREATE TABLE IF NOT EXISTS professors (</span>
<span class="s2">                id INTEGER PRIMARY KEY AUTOINCREMENT,</span>
<span class="s2">                first_name TEXT,</span>
<span class="s2">                last_name TEXT,</span>
<span class="s2">                p_id TEXT</span>
<span class="s2">            )</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="p">)</span>
    
    <span class="c1"># Create the &#39;class_professors&#39; table for many-to-many relationship</span>
    <span class="c1"># between classes and professors</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;CREATE TABLE IF NOT EXISTS class_professors (</span>
<span class="s2">            class_id INTEGER,</span>
<span class="s2">            professor_id INTEGER,</span>
<span class="s2">            FOREIGN KEY (class_id) REFERENCES classes(id),</span>
<span class="s2">            FOREIGN KEY (professor_id) REFERENCES professors(id)</span>
<span class="s2">            UNIQUE (class_id, professor_id)</span>
<span class="s2">        )&quot;&quot;&quot;</span>
    <span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># Save changes</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>



<div class="viewcode-block" id="insert_csv_into_table">
<a class="viewcode-back" href="../app.html#app.insert_csv_into_table">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">insert_csv_into_table</span><span class="p">(</span><span class="n">course_data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Insert parsed CSV data into the ``classes`` table.</span>

<span class="sd">    :param course_data: List of dictionaries with course info.</span>
<span class="sd">    :type course_data: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

    <span class="c1"># Start the crosslist checking and generating the dictionary dynamically based on if a class is crosslisted</span>
    <span class="n">cross_lists</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># Loop &amp; check if a class is cross listed</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">course_data</span><span class="p">:</span>
        <span class="n">cross_list</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cross-listings&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cross_list</span><span class="p">:</span>
            <span class="c1"># reconstructing the key, take out spaces and split them with the &quot;/&quot;, reconstruct to make sure everything works fine</span>
            <span class="n">courses</span> <span class="o">=</span> <span class="p">[</span><span class="n">course_num</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">course_num</span> <span class="ow">in</span> <span class="n">cross_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
            <span class="n">cross_list_key</span> <span class="o">=</span> <span class="s2">&quot; / &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">courses</span><span class="p">))</span>
            <span class="c1"># If there is a crosslist in the column and the key is not in the dictionary</span>
            <span class="k">if</span> <span class="n">cross_list_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cross_lists</span><span class="p">:</span>
                <span class="c1">#add it</span>
                <span class="n">cross_lists</span><span class="p">[</span><span class="n">cross_list_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cross_lists</span><span class="p">[</span><span class="n">cross_list_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Course&quot;</span><span class="p">])</span>

    <span class="c1"># for entry in course_data:</span>
    <span class="c1"># added some crosslist stuff here to check if it is in the dictionary generated from above</span>
    <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">course_data</span><span class="p">:</span>
        <span class="c1"># Info to get to see if crosslisted</span>
        <span class="n">course</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;Course&quot;</span><span class="p">]</span>
        <span class="n">cross_list</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Cross-listings&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cross_list</span><span class="p">:</span>
            <span class="c1"># same key stuff as above, just re constructing so the keys are universal</span>
            <span class="n">courses</span> <span class="o">=</span> <span class="p">[</span><span class="n">course_num</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">course_num</span> <span class="ow">in</span> <span class="n">cross_list</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)]</span>
            <span class="n">cross_list_key</span> <span class="o">=</span> <span class="s2">&quot; / &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">courses</span><span class="p">))</span>
        <span class="c1"># This is where the check is to see if the class is 1- Cross listed in the column is a key in the dictionary, 2- if the course is a value in the key</span>
        <span class="k">if</span> <span class="n">cross_list_key</span> <span class="ow">in</span> <span class="n">cross_list</span> <span class="ow">and</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">cross_lists</span><span class="p">[</span><span class="n">cross_list_key</span><span class="p">]:</span>
            <span class="c1"># List to get which courses are crosslisted under one particular key, loop through course data once again and get all the courses and check each one to see if it is a course in one particular key</span>
            <span class="n">group_crosslists</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">cross_list_entry</span> <span class="ow">in</span> <span class="n">course_data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cross_list_entry</span><span class="p">[</span><span class="s2">&quot;Course&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">cross_lists</span><span class="p">[</span><span class="n">cross_list_key</span><span class="p">]:</span>
                    <span class="n">group_crosslists</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cross_list_entry</span><span class="p">)</span>
            <span class="c1"># Take account all of enrollment and sum them up together, but this time looping through that list of all the course under one particular key</span>
            <span class="n">total_enrollment</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">course</span><span class="p">[</span><span class="s2">&quot;Enrollment&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">group_crosslists</span><span class="p">)</span>
            <span class="n">total_max</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">course</span><span class="p">[</span><span class="s2">&quot;Maximum Enrollment&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">course</span> <span class="ow">in</span> <span class="n">group_crosslists</span><span class="p">)</span>
            <span class="c1"># To properly get the sqlite statement</span>
            <span class="n">grouped_class</span> <span class="o">=</span> <span class="n">group_crosslists</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># There is an ignore statement as since the primary key was changed, it will error if it finds a duplicate, IGNORE will ignore the duplicates</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;INSERT OR IGNORE INTO classes (term, course_number, section, course_title, room, meeting_pattern, enrollment, max_enrollment) </span>
<span class="s2">            VALUES (?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="s2">            &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">grouped_class</span><span class="p">[</span><span class="s1">&#39;Term&#39;</span><span class="p">],</span> <span class="n">cross_list_key</span><span class="p">,</span> <span class="n">grouped_class</span><span class="p">[</span><span class="s1">&#39;Section #&#39;</span><span class="p">],</span> <span class="n">grouped_class</span><span class="p">[</span><span class="s1">&#39;Course Title&#39;</span><span class="p">],</span> <span class="n">grouped_class</span><span class="p">[</span><span class="s1">&#39;Room&#39;</span><span class="p">],</span> <span class="n">grouped_class</span><span class="p">[</span><span class="s1">&#39;Meeting Pattern&#39;</span><span class="p">],</span> <span class="n">total_enrollment</span><span class="p">,</span> <span class="n">grouped_class</span><span class="p">[</span><span class="s2">&quot;Cross-list Maximum&quot;</span><span class="p">]))</span>

            <span class="c1"># Get the newest class ID</span>
            <span class="n">class_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

            <span class="c1"># Parse intstructor from csv and get needed info for adding to database</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">parse_instructor</span><span class="p">(</span><span class="n">grouped_class</span><span class="p">[</span><span class="s1">&#39;Instructor&#39;</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">professor_dict</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">first_name</span> <span class="o">=</span> <span class="n">professor_dict</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span>
                <span class="n">last_name</span> <span class="o">=</span> <span class="n">professor_dict</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span>
                <span class="n">professor_id</span> <span class="o">=</span> <span class="n">professor_dict</span><span class="p">[</span><span class="s1">&#39;p_id&#39;</span><span class="p">]</span>

                <span class="c1"># Insert the class-professor relationship into the class_professors table and </span>
                <span class="c1"># add the professor to the database if they don&#39;t exist</span>
                <span class="n">get_or_create_professor</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">professor_id</span><span class="p">,</span> <span class="n">class_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Insert non crosslisted class into the database</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">                INSERT OR IGNORE INTO classes (term, course_number, section, course_title, room, meeting_pattern, enrollment, max_enrollment)</span>
<span class="s2">                VALUES (?, ?, ?, ?, ?, ?, ?, ?)</span>
<span class="s2">                &quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Term&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Course&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Section #&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Course Title&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Room&#39;</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Meeting Pattern&#39;</span><span class="p">],</span> 
                    <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Enrollment&#39;</span><span class="p">]),</span> <span class="nb">int</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Maximum Enrollment&#39;</span><span class="p">])))</span>
            <span class="c1"># Get the newest class ID</span>
            <span class="n">class_id</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">lastrowid</span>

            <span class="c1"># Parse intstructor from csv and get needed info for adding to database</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">parse_instructor</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s1">&#39;Instructor&#39;</span><span class="p">])</span>
            
            <span class="k">for</span> <span class="n">professor_dict</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">first_name</span> <span class="o">=</span> <span class="n">professor_dict</span><span class="p">[</span><span class="s1">&#39;first_name&#39;</span><span class="p">]</span>
                <span class="n">last_name</span> <span class="o">=</span> <span class="n">professor_dict</span><span class="p">[</span><span class="s1">&#39;last_name&#39;</span><span class="p">]</span>
                <span class="n">professor_id</span> <span class="o">=</span> <span class="n">professor_dict</span><span class="p">[</span><span class="s1">&#39;p_id&#39;</span><span class="p">]</span>

                <span class="c1"># Insert the class-professor relationship into the class_professors table and </span>
                <span class="c1"># add the professor to the database if they don&#39;t exist</span>
                <span class="n">get_or_create_professor</span><span class="p">(</span><span class="n">cursor</span><span class="p">,</span> <span class="n">first_name</span><span class="p">,</span> <span class="n">last_name</span><span class="p">,</span> <span class="n">professor_id</span><span class="p">,</span> <span class="n">class_id</span><span class="p">)</span>
                
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data should now properly be inserted into the database from the csv file&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_csv">
<a class="viewcode-back" href="../app.html#app.parse_csv">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">parse_csv</span><span class="p">(</span><span class="n">csv_document</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse the CSV file and return structured course data.</span>

<span class="sd">    Skips the first two lines before reading headers.</span>

<span class="sd">    :param csv_document: Path to the CSV file.</span>
<span class="sd">    :type csv_document: str</span>
<span class="sd">    :return: List of dictionaries representing each course entry.</span>
<span class="sd">    :rtype: list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">course_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">relevant_columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Term&quot;</span><span class="p">,</span> <span class="s2">&quot;Course&quot;</span><span class="p">,</span> <span class="s2">&quot;Section #&quot;</span><span class="p">,</span> <span class="s2">&quot;Course Title&quot;</span><span class="p">,</span> <span class="s2">&quot;Room&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;Meeting Pattern&quot;</span><span class="p">,</span> <span class="s2">&quot;Enrollment&quot;</span><span class="p">,</span> <span class="s2">&quot;Maximum Enrollment&quot;</span><span class="p">,</span> 
                        <span class="s2">&quot;Cross-listings&quot;</span><span class="p">,</span> <span class="s2">&quot;Instructor&quot;</span><span class="p">,</span> <span class="s2">&quot;Cross-list Maximum&quot;</span><span class="p">]</span>

    <span class="c1"># Read and process csv file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csv_document</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>

        <span class="c1"># Skip first two lines (extra headers)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
        <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

        <span class="c1"># Read the actual headers</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>

        <span class="c1"># Get the indexes of the relevant columns</span>
        <span class="n">col_indexes</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">headers</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">relevant_columns</span><span class="p">}</span>

        <span class="c1"># Read and store rows as dictionaries</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="c1"># Ensure row has enough columns before storing</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">col_indexes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># appends information into a list of </span>
                <span class="c1"># dictionaries per class entry</span>
                <span class="n">course_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;Term&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Term&quot;</span><span class="p">]],</span>
                    <span class="s2">&quot;Course&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Course&quot;</span><span class="p">]],</span>
                    <span class="s2">&quot;Section #&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Section #&quot;</span><span class="p">]],</span>
                    <span class="s2">&quot;Course Title&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Course Title&quot;</span><span class="p">]],</span>
                    <span class="s2">&quot;Room&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Room&quot;</span><span class="p">]],</span>
                    <span class="s2">&quot;Meeting Pattern&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Meeting Pattern&quot;</span><span class="p">]],</span>
                    <span class="s2">&quot;Enrollment&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Enrollment&quot;</span><span class="p">]]),</span>  <span class="c1"># Convert to int</span>
                    <span class="s2">&quot;Maximum Enrollment&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Maximum Enrollment&quot;</span><span class="p">]]),</span>
                    <span class="s2">&quot;Cross-listings&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Cross-listings&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="s2">&quot;Instructor&quot;</span><span class="p">:</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Instructor&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                    <span class="s2">&quot;Cross-list Maximum&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Cross-list Maximum&quot;</span><span class="p">]])</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">col_indexes</span><span class="p">[</span><span class="s2">&quot;Cross-list Maximum&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="mi">0</span>

                <span class="p">})</span>
    
    <span class="c1"># Returns a list of dicts (one dict per class entry)</span>
    <span class="k">return</span> <span class="n">course_data</span></div>



<span class="c1"># API Route to update enrollment for a class</span>
<div class="viewcode-block" id="update_enrollment">
<a class="viewcode-back" href="../app.html#app.update_enrollment">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/class/&lt;int:class_id&gt;/update-enrollment&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">update_enrollment</span><span class="p">(</span><span class="n">class_id</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update enrollment for a specific class by ID.</span>

<span class="sd">    Increments or decrements the enrollment number according to the request </span>
<span class="sd">    (``add`` or ``remove``). If the maximum capacity is reached, adding is not allowed. </span>
<span class="sd">    If enrollment is zero, removing is not allowed.</span>

<span class="sd">    :param class_id: ID of the class to update.</span>
<span class="sd">    :type class_id: int</span>

<span class="sd">    :return: JSON response containing the updated enrollment or an error message.</span>
<span class="sd">    :rtype: flask.Response</span>

<span class="sd">    :status 200: Class found and enrollment updated successfully.</span>
<span class="sd">    :status 400: Invalid update (e.g., class is full or empty).</span>
<span class="sd">    :status 404: Class not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;action&quot;</span><span class="p">)</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>  <span class="c1"># Connect to database</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT enrollment, max_enrollment FROM classes WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">class_id</span><span class="p">,))</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">row</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Class not found&quot;</span><span class="p">}),</span> <span class="mi">404</span>
    
    <span class="n">enrollment</span><span class="p">,</span> <span class="n">max_enrollment</span> <span class="o">=</span> <span class="n">row</span>

    <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">enrollment</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">max_enrollment</span> <span class="o">+</span> <span class="mi">9</span><span class="p">):</span>
            <span class="n">enrollment</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Class is full&quot;</span><span class="p">}),</span>
    <span class="k">elif</span> <span class="n">action</span> <span class="o">==</span> <span class="s2">&quot;remove&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">enrollment</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">enrollment</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Class is empty&quot;</span><span class="p">}),</span> <span class="mi">400</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">enrollment</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>  <span class="c1"># Set enrollment to a specific number</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;Invalid action&quot;</span><span class="p">}),</span> <span class="mi">400</span>
        
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;UPDATE classes SET enrollment = ? WHERE id = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">enrollment</span><span class="p">,</span> <span class="n">class_id</span><span class="p">))</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;enrollment&quot;</span><span class="p">:</span> <span class="n">enrollment</span><span class="p">}),</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="get_swap_recommendations">
<a class="viewcode-back" href="../app.html#app.get_swap_recommendations">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/swap-recommendations&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_swap_recommendations</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the algorithm to get swap recommendations for classes</span>
<span class="sd">    and show them to the user (class coordinators).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">db_path</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">]</span>

    <span class="n">same_slot_swaps</span><span class="p">,</span> <span class="n">not_swappable</span> <span class="o">=</span> <span class="n">recommend_swaps_per_timeslot</span><span class="p">(</span><span class="n">db_path</span><span class="p">)</span>
    <span class="n">cross_slot_recommendations</span> <span class="o">=</span> <span class="n">recommended_swaps_if_no_swaps_in_same_timeslot</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">not_swappable</span><span class="p">)</span>

    <span class="c1"># Combine the recommendations into a single response</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;same_slot_swaps&quot;</span><span class="p">:</span> <span class="n">same_slot_swaps</span><span class="p">,</span>
            <span class="s2">&quot;cross_slot_recommendations&quot;</span><span class="p">:</span> <span class="n">cross_slot_recommendations</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">),</span> <span class="mi">200</span></div>


<span class="c1"># API Route to swap (relevant) class data</span>
<div class="viewcode-block" id="swap_classes">
<a class="viewcode-back" href="../app.html#app.swap_classes">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/swap-classrooms&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;POST&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">swap_classes</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Swaps two classes&#39; data.</span>
<span class="sd">    </span>
<span class="sd">    Both classes have to reside in the database.</span>

<span class="sd">    :return: JSON response indicating success or an error message.</span>
<span class="sd">    :rtype: flask.Response</span>

<span class="sd">    :status 200: Successfully swapped classes</span>
<span class="sd">    :status 400: Failed to swap classes</span>
<span class="sd">    :status 404: One of the classes was not found</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
    <span class="n">class_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;crowded_id&quot;</span><span class="p">)</span>
    <span class="n">swap_id</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target_id&quot;</span><span class="p">)</span>
    <span class="n">different_timeslot</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;different_timeslot&quot;</span><span class="p">))</span>

    <span class="c1"># Get current class details</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">get_class_details</span><span class="p">(</span><span class="n">class_id</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">get_class_details</span><span class="p">(</span><span class="n">swap_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">c1</span> <span class="ow">and</span> <span class="n">c2</span><span class="p">:</span>
        <span class="c1"># Only the max enrollment and room location need to be swapped</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="p">[</span><span class="n">c2</span><span class="p">[</span><span class="s2">&quot;maxEnrollment&quot;</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;room&quot;</span><span class="p">]]</span>
        <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;maxEnrollment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;maxEnrollment&quot;</span><span class="p">]</span>
        <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;room&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;room&quot;</span><span class="p">]</span>
        <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;maxEnrollment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;room&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Update the timeslot if the timeslot is different using a ternary operation</span>
        <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span> <span class="k">if</span> <span class="n">different_timeslot</span> <span class="k">else</span> <span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>
            <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;UPDATE classes SET max_enrollment = ?, room = ?, meeting_pattern = ? WHERE id = ?&#39;</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">c1</span><span class="p">[</span><span class="s2">&quot;maxEnrollment&quot;</span><span class="p">],</span> <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;room&quot;</span><span class="p">],</span> <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">c1</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;UPDATE classes SET max_enrollment = ?, room = ?, meeting_pattern = ? WHERE id = ?&#39;</span><span class="p">,</span> 
                <span class="p">(</span><span class="n">c2</span><span class="p">[</span><span class="s2">&quot;maxEnrollment&quot;</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;room&quot;</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]))</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">different_timeslot</span><span class="p">:</span>
                <span class="n">log_swap</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s2"> - &quot;</span>\
                    <span class="sa">f</span><span class="s2">&quot;SAME-TIME SLOT SWAP: </span><span class="si">{</span><span class="n">c1</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c1</span><span class="p">[</span><span class="s1">&#39;courseName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">c2</span><span class="p">[</span><span class="s1">&#39;room&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) -&gt; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c2</span><span class="p">[</span><span class="s1">&#39;courseName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">c1</span><span class="p">[</span><span class="s1">&#39;room&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  
                <span class="n">log_swap</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">:</span><span class="s2">%Y-%m-%d %H:%M:%S</span><span class="si">}</span><span class="s2"> - &quot;</span>\
                    <span class="sa">f</span><span class="s2">&quot;DIFFERENT-TIME SLOT SWAP: </span><span class="si">{</span><span class="n">c1</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">c2</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c1</span><span class="p">[</span><span class="s1">&#39;courseName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">c2</span><span class="p">[</span><span class="s1">&#39;room&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">) -&gt; &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c2</span><span class="p">[</span><span class="s1">&#39;courseName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">c1</span><span class="p">[</span><span class="s1">&#39;room&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">swap_file</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">logfile</span><span class="p">:</span>
                <span class="n">logfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">log_swap</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="s1">&#39;Successfully swapped classes.&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="s1">&#39;Failed to insert changes into the database.&#39;</span><span class="p">,</span> <span class="mi">400</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># realistically this shouldn&#39;t hit</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="s1">&#39;Could not find one of the classes.&#39;</span><span class="p">,</span> <span class="mi">404</span><span class="p">)</span></div>



<div class="viewcode-block" id="export_to_csv">
<a class="viewcode-back" href="../app.html#app.export_to_csv">[docs]</a>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/export&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;PUT&quot;</span><span class="p">])</span>
<span class="k">def</span><span class="w"> </span><span class="nf">export_to_csv</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Export classes from the database into a CSV file named ``output.csv``.</span>

<span class="sd">    Reads data from the existing CSV (referenced by ``file_path``) and updates</span>
<span class="sd">    enrollment values using the database. Ensures the first row is the term,</span>
<span class="sd">    the second row is the generation date/time, and subsequent rows contain</span>
<span class="sd">    updated class info.</span>

<span class="sd">    :return: JSON response indicating success or an error message.</span>
<span class="sd">    :rtype: flask.Response</span>

<span class="sd">    :status 200: Successfully exported data to file.</span>
<span class="sd">    :status 404: No database or error accessing records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">file_path</span>

    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s2">&quot;DB_FILE&quot;</span><span class="p">])</span>
    <span class="n">desktop_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;USERPROFILE&#39;</span><span class="p">]),</span> <span class="s1">&#39;Desktop&#39;</span><span class="p">)</span>
    <span class="n">output_destination</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desktop_path</span><span class="p">,</span> <span class="s2">&quot;output.csv&quot;</span><span class="p">)</span>
    <span class="c1"># check to make sure the connection worked</span>
    <span class="c1"># likely will remove this later. I&#39;m thinking we disable the button if theres no database/problems if possible</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

        <span class="c1"># the idea here is to go line by line and copy each line into a list. </span>
        <span class="c1"># if there&#39;s something in the first list, process depending on where it is (date, class name, etc.)</span>
        <span class="c1"># if not, process new student count (since data lines have their first csv data empty)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">in_file</span><span class="p">:</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>

            <span class="c1"># start overwriting the csv file. start with writing the date</span>
            <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="n">season</span><span class="p">,</span> <span class="n">year</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_destination</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NOTNULL</span><span class="p">)</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">season</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>

            <span class="c1"># append date, then column headers</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_destination</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span> <span class="c1"># skip date in the input</span>
                <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NOTNULL</span><span class="p">)</span>

                <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                <span class="c1"># stripping leading zeroes off the current month, day, and hour</span>
                <span class="n">month</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="n">day</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="n">hour</span> <span class="o">=</span> <span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%I&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;Generated </span><span class="si">{</span><span class="n">month</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">day</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">, </span><span class="si">{</span><span class="n">hour</span><span class="si">}{</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;:%M:%S %p&quot;</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># write date</span>

                <span class="n">data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># first column doesn&#39;t get quoted</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># write headers </span>

            <span class="c1"># start writing in all the new data</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM classes&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># process new data</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_destination</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NOTNULL</span><span class="p">)</span>
                        
                        <span class="c1"># instead of searching via an incrementing id, write each row of the database one by one</span>
                        <span class="n">db_row</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                        <span class="c1"># stop when the end of the database is reached</span>
                        <span class="k">if</span> <span class="n">db_row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">break</span>

                        <span class="c1"># data is whatever&#39;s in the input csv file</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">row</span>
                        <span class="n">new_enrollment_count</span> <span class="o">=</span> <span class="n">db_row</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># so it doesn&#39;t get quoted in the csv file</span>
                        <span class="n">data</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_enrollment_count</span> <span class="c1"># 28 is the index of the current enrollment count. if there&#39;s a more dynamic way to do this in case the data format changes, let&#39;s do that instead</span>

                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="c1"># copy row</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">output_destination</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out_file</span><span class="p">:</span>
                        <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">quoting</span><span class="o">=</span><span class="n">csv</span><span class="o">.</span><span class="n">QUOTE_NOTNULL</span><span class="p">)</span>
                        <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="s2">&quot;No database exists.&quot;</span><span class="p">),</span> <span class="mi">404</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Successfully exported data to file.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="s1">&#39;Successfully exported data to file.&#39;</span><span class="p">),</span> <span class="mi">200</span></div>



<span class="c1"># Start the Flask Server</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Charlie, Zaid, Brian, John, Brady.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>